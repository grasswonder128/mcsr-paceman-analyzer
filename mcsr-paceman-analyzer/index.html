<!DOCTYPE html>
<html>
<head>
    <title>Paceman数据分析</title>
    <style>
        :root {
            --primary-color: #2c5530;
            --secondary-color: #4a7c59;
            --accent-color: #7fb685;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            justify-content: center;
        }
        
        input {
            padding: 12px 15px;
            width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 2px 10px rgba(74, 124, 89, 0.2);
        }
        
        button {
            padding: 12px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .error {
            background: #ffeaea;
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        .success {
            background: #eaffea;
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .info {
            background: #eaf4ff;
            color: var(--info-color);
            border-left: 4px solid var(--info-color);
        }
        
        .stats {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        
        .chart-container {
            width: 100%;
            margin: 25px 0;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            background: white;
            box-sizing: border-box;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .chart-container h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
            font-weight: 600;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .run-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .run-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s ease;
        }
        
        .run-item:hover {
            background: #f9f9f9;
        }
        
        .run-item:last-child {
            border-bottom: none;
        }
        
        .run-date {
            color: #666;
        }
        
        .run-time {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .segment-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .segment-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease;
        }
        
        .segment-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.08);
        }
        
        .segment-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .segment-value {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab:hover:not(.active) {
            color: var(--secondary-color);
            background: rgba(44, 85, 48, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 15px;
            background: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: none;
        }
        
        .pagination button:hover {
            transform: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pagination button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .completion-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .completion-stat {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            border-top: 4px solid var(--secondary-color);
        }
        
        .completion-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .completion-value {
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .completion-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        
        .time-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .time-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .time-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .time-stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .chart-wrapper {
            width: 100%;
            height: 350px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #f8f9fa;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .comparison-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .comparison-player {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .remove-player {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .remove-player:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .comparison-chart {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        
        .comparison-line {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .comparison-line:hover {
            background: #e9ecef;
        }
        
        .player-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .player-name {
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .search-box {
                flex-direction: column;
                align-items: center;
            }
            
            input {
                width: 100%;
                max-width: 300px;
            }
            
            .stat-grid,
            .completion-stats {
                grid-template-columns: 1fr;
            }
            
            .segment-stats {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 280px;
            }
            
            .comparison-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Paceman数据分析</h1>
        
        <div class="search-box">
            <input type="text" id="playerName" placeholder="输入玩家名称 (如: meebie, couriway, feinberg)">
            <button id="loadButton" onclick="loadData()">加载数据</button>
        </div>
        
        <div id="message"></div>
        
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>正在获取数据...</p>
        </div>
        
        <div id="content" class="hidden">
            <div class="tabs">
                <div class="tab active" data-tab="overview">概览</div>
                <div class="tab" data-tab="comparison">玩家对比</div>
            </div>
            
            <div class="tab-content active" id="overview-tab">
                <div id="playerStats" class="stats">
                    <!-- 玩家统计数据将在这里显示 -->
                </div>
                
                <div class="chart-container">
                    <h2>分段统计</h2>
                    <div id="segmentStats" class="segment-stats">
                        <!-- 分段统计数据将在这里显示 -->
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2>运行记录 <span id="runCount"></span></h2>
                    <div id="runList" class="run-list">
                        <!-- 运行记录将在这里显示 -->
                    </div>
                    <div id="pagination" class="pagination">
                        <!-- 分页按钮将在这里显示 -->
                    </div>
                </div>
                
                <div class="chart-container">
                    <h2>时间趋势</h2>
                    <div class="chart-wrapper">
                        <canvas id="trendChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="comparison-tab">
                <div class="chart-container">
                    <h2>玩家对比</h2>
                    <div class="comparison-controls">
                        <input type="text" id="comparePlayer1" placeholder="玩家1名称">
                        <input type="text" id="comparePlayer2" placeholder="玩家2名称">
                        <button id="compareButton" onclick="comparePlayers()">对比玩家</button>
                    </div>
                    
                    <div id="comparisonResult" class="hidden">
                        <h3>分段独立时间对比</h3>
                        <div id="comparisonLines">
                            <!-- 对比线条将在这里显示 -->
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="comparisonChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-legend" id="comparisonLegend"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置
        const API_BASE = 'http://localhost:3001';
        
        // 分页相关变量
        let currentPage = 1;
        const runsPerPage = 20;
        let allRuns = [];
        
        // 玩家颜色映射
        const playerColors = {
            player1: '#4a7c59',
            player2: '#e74c3c',
            player3: '#3498db',
            player4: '#f39c12'
        };
        
        // 显示消息函数
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }
        
        // 显示/隐藏加载指示器
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            const loadButton = document.getElementById('loadButton');
            
            if (show) {
                loadingDiv.classList.remove('hidden');
                loadButton.disabled = true;
                loadButton.textContent = '加载中...';
            } else {
                loadingDiv.classList.add('hidden');
                loadButton.disabled = false;
                loadButton.textContent = '加载数据';
            }
        }
        
        // 格式化时间函数
        function formatTime(timeValue) {
            if (typeof timeValue === 'string' && timeValue.includes(':')) {
                return timeValue;
            }
            
            if (typeof timeValue === 'number') {
                const seconds = Math.floor(timeValue / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            
            return "N/A";
        }
        
        // 从API响应中提取时间值
        function extractTimeValue(timeData) {
            if (!timeData) return null;
            
            if (typeof timeData === 'number') {
                return timeData;
            }
            
            if (timeData.avg !== undefined && timeData.avg !== null) {
                if (typeof timeData.avg === 'string') {
                    const parts = timeData.avg.split(':');
                    if (parts.length === 2) {
                        const minutes = parseInt(parts[0]);
                        const seconds = parseInt(parts[1]);
                        if (!isNaN(minutes) && !isNaN(seconds)) {
                            const totalMs = (minutes * 60 + seconds) * 1000;
                            return totalMs;
                        }
                    }
                }
                
                if (typeof timeData.avg === 'number') {
                    return timeData.avg;
                }
            }
            
            if (timeData.count !== undefined && timeData.count !== null) {
                return timeData.count;
            }
            
            return null;
        }
        
        // 计算完成的运行记录
        function calculateCompletionStats(runs) {
            const completedRuns = runs.filter(run => run.finish && run.finish !== null);
            const completionCount = completedRuns.length;
            
            let avgCompletionTime = "N/A";
            if (completionCount > 0) {
                const totalCompletionTime = completedRuns.reduce((sum, run) => sum + run.finish, 0);
                avgCompletionTime = formatTime(totalCompletionTime / completionCount);
            }
            
            return {
                count: completionCount,
                averageTime: avgCompletionTime
            };
        }
        
        // 初始化图表
        function initCharts() {
            const trendCanvas = document.getElementById('trendChart');
            const comparisonCanvas = document.getElementById('comparisonChart');
            
            if (trendCanvas) {
                // 设置canvas尺寸
                trendCanvas.width = trendCanvas.offsetWidth;
                trendCanvas.height = trendCanvas.offsetHeight;
                const ctx = trendCanvas.getContext('2d');
                drawEmptyChart(ctx, trendCanvas, '加载玩家数据后，时间趋势图表将在这里显示');
            }
            
            if (comparisonCanvas) {
                // 设置canvas尺寸
                comparisonCanvas.width = comparisonCanvas.offsetWidth;
                comparisonCanvas.height = comparisonCanvas.offsetHeight;
                const ctx = comparisonCanvas.getContext('2d');
                drawEmptyChart(ctx, comparisonCanvas, '输入玩家名称并点击"对比玩家"按钮后，对比图表将在这里显示');
            }
        }
        
        // 加载数据主函数
        async function loadData() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showMessage('请输入玩家名称', 'error');
                return;
            }
            
            showLoading(true);
            showMessage('正在加载数据...', 'info');
            
            currentPage = 1;
            allRuns = [];
            
            try {
                // 获取统计数据
                const statsResponse = await fetch(`${API_BASE}/getStats?name=${playerName}`);
                if (!statsResponse.ok) {
                    throw new Error(`获取统计数据失败: ${statsResponse.status}`);
                }
                const statsData = await statsResponse.json();
                
                if (!statsData.success) {
                    throw new Error(statsData.message || '获取数据失败');
                }
                
                // 获取运行记录
                const runsResponse = await fetch(`${API_BASE}/getRecentRuns?name=${playerName}&limit=1000`);
                if (!runsResponse.ok) {
                    throw new Error(`获取运行记录失败: ${runsResponse.status}`);
                }
                const runsData = await runsResponse.json();
                
                if (!runsData.success) {
                    throw new Error(runsData.message || '获取运行记录失败');
                }
                
                allRuns = runsData.runs || [];
                
                // 显示数据
                displayStats(playerName, statsData, runsData);
                displaySegmentStats(statsData);
                displayRunList();
                
                // 确保内容区域显示后再绘制图表
                document.getElementById('content').classList.remove('hidden');
                
                // 使用setTimeout确保DOM已更新
                setTimeout(() => {
                    displayTimeTrend();
                }, 100);
                
                showMessage(`成功加载玩家 "${playerName}" 的数据，共 ${allRuns.length} 条记录`, 'success');
                
            } catch (error) {
                console.error('加载数据错误:', error);
                showMessage(`错误: ${error.message}`, 'error');
                document.getElementById('content').classList.add('hidden');
            } finally {
                showLoading(false);
            }
        }
        
        // 显示统计数据
        function displayStats(playerName, statsData, runsData) {
            const statsDiv = document.getElementById('playerStats');
            const stats = statsData.stats;
            
            // 使用分段统计中进入下届的完成次数作为30天下届数
            const netherCount = stats.nether ? stats.nether.count : 0;
            
            // 计算进入末地次数
            const runsWithEnd = allRuns.filter(run => run.end && run.end !== null).length;
            
            // 计算进入末地率 
            const endRate = netherCount > 0 ? 
                ((runsWithEnd / netherCount) * 100).toFixed(1) + '%' : '0%';

            // 完成率算法 
            const completionStats = calculateCompletionStats(allRuns);
            const completionRate = netherCount > 0 ? 
                ((completionStats.count / netherCount) * 100).toFixed(1) + '%' : '0%';
            
            let avgEndTime = "N/A";
            if (stats.end) {
                const endTimeValue = extractTimeValue(stats.end);
                avgEndTime = formatTime(endTimeValue);
            }
            
            statsDiv.innerHTML = `
                <h2>玩家: ${playerName}</h2>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${netherCount}</div>
                        <div class="stat-label">30天下届数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${runsWithEnd}</div>
                        <div class="stat-label">进入末地次数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${completionStats.count}</div>
                        <div class="stat-label">完成次数</div>
                    </div>
                </div>
                <div class="completion-stats">
                    <div class="completion-stat">
                        <div class="completion-value">${endRate}</div>
                        <div class="completion-label">进入末地率</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-value">${completionRate}</div>
                        <div class="completion-label">完成率</div>
                    </div>
                </div>
                <div class="time-stats">
                    <div class="time-stat">
                        <div class="time-stat-value">${avgEndTime}</div>
                        <div class="time-stat-label">进入末地平均时间</div>
                    </div>
                    <div class="time-stat">
                        <div class="time-stat-value">${completionStats.averageTime}</div>
                        <div class="time-stat-label">完成平均时间</div>
                    </div>
                </div>
            `;
        }
        
        // 显示分段统计数据 
        function displaySegmentStats(statsData) {
            const segmentStatsDiv = document.getElementById('segmentStats');
            const stats = statsData.stats;
            
            const segments = [
                { key: 'nether', name: '进入下界' },
                { key: 'bastion', name: '找到猪灵堡垒' },
                { key: 'fortress', name: '进入下届要塞' },
                { key: 'first_portal', name: '寻找要塞' },
                { key: 'stronghold', name: '已找到要塞' },
                { key: 'end', name: '进入末地' },
                { key: 'finish', name: '完成' }
            ];
            
            let segmentHTML = '';
            
            segments.forEach(segment => {
                if (stats[segment.key]) {
                    const segmentData = stats[segment.key];
                    const timeValue = extractTimeValue(segmentData);
                    const countValue = segmentData.count || 0;
                    
                    segmentHTML += `
                        <div class="segment-item">
                            <div class="segment-name">${segment.name}</div>
                            <div class="segment-value">
                                平均时间: ${formatTime(timeValue)}<br>
                                完成次数: ${countValue}
                            </div>
                        </div>
                    `;
                }
            });
            
            segmentStatsDiv.innerHTML = segmentHTML || '<p>暂无分段数据</p>';
        }
        
        // 显示运行记录
        function displayRunList() {
            const runListDiv = document.getElementById('runList');
            const runCountDiv = document.getElementById('runCount');
            const paginationDiv = document.getElementById('pagination');
            
            if (allRuns.length === 0) {
                runListDiv.innerHTML = '<p>暂无运行记录</p>';
                runCountDiv.textContent = '';
                paginationDiv.innerHTML = '';
                return;
            }
            
            runCountDiv.textContent = `(${allRuns.length} 条记录)`;
            
            const totalPages = Math.ceil(allRuns.length / runsPerPage);
            const startIndex = (currentPage - 1) * runsPerPage;
            const endIndex = Math.min(startIndex + runsPerPage, allRuns.length);
            const pageRuns = allRuns.slice(startIndex, endIndex);
            
            let runHTML = '';
            
            pageRuns.forEach(run => {
                const date = run.time ? new Date(run.time * 1000).toLocaleDateString() : '未知日期';
                const endTime = formatTime(run.end);
                const finishTime = run.finish ? formatTime(run.finish) : '未完成';
                
                runHTML += `
                    <div class="run-item">
                        <div class="run-date">${date}</div>
                        <div class="run-time">
                            ${endTime}${run.finish ? ` / ${finishTime}` : ''}
                        </div>
                    </div>
                `;
            });
            
            runListDiv.innerHTML = runHTML;
            
            let paginationHTML = '';
            
            if (totalPages > 1) {
                if (currentPage > 1) {
                    paginationHTML += `<button onclick="changePage(${currentPage - 1})">上一页</button>`;
                }
                
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                }
                
                if (currentPage < totalPages) {
                    paginationHTML += `<button onclick="changePage(${currentPage + 1})">下一页</button>`;
                }
            }
            
            paginationDiv.innerHTML = paginationHTML;
        }
        
        
        function changePage(page) {
            currentPage = page;
            displayRunList();
        }
        
        // 显示时间趋势 
        function displayTimeTrend() {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            
            if (allRuns.length === 0) {
                drawEmptyChart(ctx, canvas, '加载玩家数据后，时间趋势图表将在这里显示');
                return;
            }
            
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // 取最近15次运行记录用于显示趋势
            const trendRuns = allRuns.slice(0, 15).reverse();
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制网格线和标签
            drawGrid(ctx, canvas.width, canvas.height);
            
            // 绘制折线图
            drawLineChart(ctx, canvas.width, canvas.height, trendRuns);
        }
        
        // 绘制网格线和标签
        function drawGrid(ctx, width, height) {
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // 绘制网格背景
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(padding, padding, chartWidth, chartHeight);
            
            // 绘制Y轴
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.stroke();
            
            // 绘制X轴
            ctx.beginPath();
            ctx.moveTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();
            
            // 绘制Y轴标签
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            // 绘制5个Y轴刻度
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight * i / 5);
                
                // 绘制水平网格线
                ctx.strokeStyle = '#e0e0e0';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
        }
        
        // 绘制折线图
        function drawLineChart(ctx, width, height, runs) {
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // 计算最大时间值
            const times = runs.map(run => run.end / 1000 / 60); // 转换为分钟
            const maxTime = Math.max(...times, 1); // 确保至少为1，避免除0错误
            
            // 绘制数据点
            ctx.fillStyle = '#4a7c59';
            ctx.strokeStyle = '#4a7c59';
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            
            runs.forEach((run, index) => {
                const timeInMinutes = run.end / 1000 / 60;
                const x = padding + (index / (runs.length - 1)) * chartWidth;
                const y = padding + chartHeight - (timeInMinutes / maxTime) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // 绘制数据点
            ctx.fillStyle = '#4a7c59';
            runs.forEach((run, index) => {
                const timeInMinutes = run.end / 1000 / 60;
                const x = padding + (index / (runs.length - 1)) * chartWidth;
                const y = padding + chartHeight - (timeInMinutes / maxTime) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // 添加日期标签
                if (index % Math.ceil(runs.length / 5) === 0) {
                    const date = run.time ? new Date(run.time * 1000).toLocaleDateString() : '未知';
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillText(date, x, padding + chartHeight + 10);
                }
            });
            
            // 添加Y轴时间标签
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight * i / 5);
                const timeValue = maxTime * (1 - i / 5);
                const timeLabel = formatTime(timeValue * 60 * 1000);
                ctx.fillText(timeLabel, padding - 10, y);
            }
        }
        
        // 对比玩家函数
        async function comparePlayers() {
            const player1 = document.getElementById('comparePlayer1').value.trim();
            const player2 = document.getElementById('comparePlayer2').value.trim();
            
            if (!player1 || !player2) {
                showMessage('请输入两个玩家名称', 'error');
                return;
            }
            
            if (player1 === player2) {
                showMessage('不能对比同一个玩家', 'error');
                return;
            }
            
            showLoading(true);
            showMessage('正在获取对比数据...', 'info');
            
            try {
                const [player1Data, player2Data] = await Promise.all([
                    fetchPlayerData(player1),
                    fetchPlayerData(player2)
                ]);
                
                if (!player1Data || !player2Data) {
                    throw new Error('获取玩家数据失败');
                }
                
                displayComparison(player1, player1Data, player2, player2Data);
                document.getElementById('comparisonResult').classList.remove('hidden');
                
                showMessage(`成功对比玩家 "${player1}" 和 "${player2}"`, 'success');
                
            } catch (error) {
                console.error('对比玩家错误:', error);
                showMessage(`对比失败: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // 获取玩家数据
        async function fetchPlayerData(playerName) {
            try {
                const statsResponse = await fetch(`${API_BASE}/getStats?name=${playerName}`);
                if (!statsResponse.ok) {
                    throw new Error(`获取玩家 ${playerName} 数据失败: ${statsResponse.status}`);
                }
                const statsData = await statsResponse.json();
                
                if (!statsData.success) {
                    throw new Error(statsData.message || '获取数据失败');
                }
                
                return statsData.stats;
            } catch (error) {
                console.error(`获取玩家 ${playerName} 数据错误:`, error);
                throw error;
            }
        }
        
        // 计算分段独立时间（当前分段时间减去上一个分段时间）
        function calculateSegmentDurations(playerData) {
            const segments = [
                { key: 'nether', name: 'ow-下界' },
                { key: 'bastion', name: '下届-堡垒' },
                { key: 'fortress', name: '堡垒-下届要塞' },
                { key: 'first_portal', name: '下届要塞-盲传' },
                { key: 'stronghold', name: '盲传-stronghold' },
                { key: 'end', name: 'stronghold-末地' }
            ];
            
            const durations = [];
            let prevTime = 0;
            
            segments.forEach(segment => {
                const currentTime = playerData[segment.key] ? 
                    extractTimeValue(playerData[segment.key]) / 1000 / 60 : 0; // 转换为分钟
                
                // 当前分段时间减去上一个分段时间
                const segmentDuration = currentTime - prevTime;
                durations.push({
                    name: segment.name,
                    duration: segmentDuration > 0 ? segmentDuration : 0 // 确保非负
                });
                
                prevTime = currentTime;
            });
            
            return durations;
        }
        
        // 显示对比结果
        function displayComparison(player1, player1Data, player2, player2Data) {
            const comparisonLinesDiv = document.getElementById('comparisonLines');
            const comparisonLegendDiv = document.getElementById('comparisonLegend');
            const canvas = document.getElementById('comparisonChart');
            
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const ctx = canvas.getContext('2d');
            
            // 创建对比线条
            let comparisonHTML = '';
            
            comparisonHTML += `
                <div class="comparison-line">
                    <div class="player-color" style="background-color: ${playerColors.player1}"></div>
                    <div class="player-name">${player1}</div>
                </div>
            `;
            
            comparisonHTML += `
                <div class="comparison-line">
                    <div class="player-color" style="background-color: ${playerColors.player2}"></div>
                    <div class="player-name">${player2}</div>
                </div>
            `;
            
            comparisonLinesDiv.innerHTML = comparisonHTML;
            
            // 创建图例
            comparisonLegendDiv.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${playerColors.player1}"></div>
                    <span>${player1}</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${playerColors.player2}"></div>
                    <span>${player2}</span>
                </div>
            `;
            
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制对比折线图
            drawComparisonLineChart(ctx, canvas.width, canvas.height, player1, player1Data, player2, player2Data);
        }
        
        // 绘制对比折线图 
        function drawComparisonLineChart(ctx, width, height, player1, player1Data, player2, player2Data) {
            const padding = 50;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // 计算分段独立时间
            const player1Durations = calculateSegmentDurations(player1Data);
            const player2Durations = calculateSegmentDurations(player2Data);
            
            // 计算最大时间值
            let maxTime = 0;
            player1Durations.forEach(item => {
                maxTime = Math.max(maxTime, item.duration);
            });
            player2Durations.forEach(item => {
                maxTime = Math.max(maxTime, item.duration);
            });
            
            // 确保maxTime至少为1，避免除0错误
            maxTime = Math.max(maxTime, 1);
            
            // 绘制网格背景
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(padding, padding, chartWidth, chartHeight);
            
            // 绘制Y轴
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.stroke();
            
            // 绘制X轴
            ctx.beginPath();
            ctx.moveTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();
            
            // 绘制Y轴标签
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight * i / 5);
                const timeValue = maxTime * (1 - i / 5);
                const timeLabel = formatTime(timeValue * 60 * 1000);
                
                ctx.fillText(timeLabel, padding - 10, y);
                
                // 绘制水平网格线
                ctx.strokeStyle = '#e0e0e0';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // 绘制玩家1的折线 - 使用分段独立时间
            ctx.strokeStyle = playerColors.player1;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            player1Durations.forEach((item, index) => {
                const x = padding + (index / (player1Durations.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.duration / maxTime) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // 绘制玩家1的数据点
            ctx.fillStyle = playerColors.player1;
            player1Durations.forEach((item, index) => {
                const x = padding + (index / (player1Durations.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.duration / maxTime) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // 添加分段标签
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText(item.name, x, padding + chartHeight + 10);
                
                // 添加时间标签
                ctx.fillStyle = playerColors.player1;
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(formatTime(item.duration * 60 * 1000), x, y - 8);
            });
            
            // 绘制玩家2的折线 - 使用分段独立时间
            ctx.strokeStyle = playerColors.player2;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            player2Durations.forEach((item, index) => {
                const x = padding + (index / (player2Durations.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.duration / maxTime) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // 绘制玩家2的数据点
            ctx.fillStyle = playerColors.player2;
            player2Durations.forEach((item, index) => {
                const x = padding + (index / (player2Durations.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.duration / maxTime) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // 添加时间标签
                ctx.fillStyle = playerColors.player2;
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(formatTime(item.duration * 60 * 1000), x, y - 8);
            });
        }
        
        // 绘制空图表
        function drawEmptyChart(ctx, canvas, message) {
            const width = canvas.width;
            const height = canvas.height;
            
            // 绘制背景
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // 绘制边框
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, width, height);
            
            // 绘制提示文本
            ctx.fillStyle = '#666';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, width/2, height/2);
        }
        
        // 标签切换功能
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            showMessage('请输入玩家名称并点击"加载数据"按钮', 'info');
            
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadData();
                }
            });
            
            initTabs();
            
            // 初始化图表
            initCharts();
        });
    </script>
</body>
</html>